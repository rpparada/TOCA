{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta name="author" content="INSPIRO" />
  <meta name="description" content="Themeforest Template Polo">

  <!-- Falta favicon -->
  <link rel="icon" type="image/png" href="{% static 'images/favicon_io/favicon.ico' %}">

  <!-- Document title -->
  <title>TOCA {% block title %}{% endblock %}</title>

  <!-- Stylesheets & Fonts -->
  <link href="{% static 'css/plugins.css' %}" rel="stylesheet">
  <link href="{% static 'css/style.css' %}" rel="stylesheet">
  <link href="{% static 'css/custom.css' %}" rel="stylesheet">

  <!-- CSS  STYLE -->
  <link rel="stylesheet" type="text/css" href="{% static 'homepages/event/css/event-style.css' %}" media="screen" />

</head>

<body>
  <!-- Body Inner -->
  <div class="body-inner">
    {% include 'partials/_header.html' %}
    {% block content %}

    {% endblock %}
    {% include 'partials/_footer.html'%}
  </div>
  <!-- end: Body Inner -->

  <!-- Scroll top -->
  <a id="scrollTop"><i class="icon-chevron-up"></i><i class="icon-chevron-up"></i></a>

  <!--Plugins-->
  <script src="{% static 'js/jquery.js' %}"></script>
  <script src="{% static 'js/plugins.js' %}"></script>

  <!--Template functions-->
  <script src="{% static 'js/functions.js' %}"></script>
  <script src="{% static 'js/custom.js' %}"></script>

  <script type="text/javascript">
    $(document).ready(function(){

      // Busqueda actomatica
      var searchForm = $(".search-form");
      var searchInput = searchForm.find("[name='q']");
      var searchBtn = searchForm.find("[type='submit']")
      var typingTimer;
      var typingInterval = 1500;
      searchInput.keyup(function(event){
        clearTimeout(typingTimer)
        typingTimer = setTimeout(ejecutaBusqueda,typingInterval);
      })
      searchInput.keydown(function(event){
        clearTimeout(typingTimer)
      })

      function ejecutaBusqueda(){
        var query = searchInput.val();
        window.location.href="/busqueda/?q="+query
      }

      // Agregar o quitar tocatas de carro y actualizar
      var tocataForm = $(".form-tocata-ajax");
      tocataForm.submit(function(event){
        event.preventDefault();
        var thisForm = $(this);
        //var actionEndpoint = thisForm.attr("action");
        var actionEndpoint = thisForm.attr("data-endpoint");
        var httpMethod = thisForm.attr("method");
        var formData = thisForm.serialize();

        $.ajax({
          url: actionEndpoint,
          method: httpMethod,
          data: formData,
          success: function(data){
            var submitSpan = thisForm.find(".submit-span")
            if (data.added){
              submitSpan.html("<button type='submit' class='btn btn-b'>Quitar del Carro</button>")
            } else {
              submitSpan.html("<button type='submit' class='btn btn-b'>Agregar al Carro</button>")
            }
            var navbarcarro = $(".navbar-carro-numitems")
            navbarcarro.text(data.carroNumItem)
            if(window.location.href.indexOf("carro") != -1) {
              actualizaCarro()
            }
          },
          error: function(errorData){
            console.log("error");
            console.log(errorData);
          }
        })
      })

      function actualizaCarro(){
        var carroTable = $(".carro-table");
        var carroTableRes = $(".carro-table-res");

        var carroBody = carroTable.find(".carro-body");
        var tocataRows = carroBody.find(".carro-tocata")

        var carroResumen = carroTableRes.find(".carro-resumen");

        var currentUrl = window.location.href

        var updateCarroUrl = "api/carro";
        var updateCarroMethod = "GET";
        var data = {};
        $.ajax({
          url: updateCarroUrl,
          method: updateCarroMethod,
          data: data,
          success: function(data){
            var formQuitarTocataCarro = $(".form-quitar-carro-home")
            if (data.tocatas.length > 0) {
              tocataRows.html(" ")
              $.each(data.tocatas, function(index, value){
                var nuevoCarroTocataQuitar = formQuitarTocataCarro.clone()
                nuevoCarroTocataQuitar.css("display","block")
                nuevoCarroTocataQuitar.find(".carro-tocata-id").val(value.id)
                carroBody.prepend("<tr class=\"carro-tocata\"><td class=\"cart-product-remove\">"+nuevoCarroTocataQuitar.html()+"</td><td class=\"cart-product-name\"><span><a href='"+value.url+"'>"+value.nombre+"</a></span></td><td class=\"cart-product-subtotal\"><span class=\"amount\">$"+value.costo+"</span></td></tr>")
              })
              carroResumen.find(".carro-subtotal").text(data.subtotal)
              carroResumen.find(".carro-total").text(data.total)
            } else {
              window.location.href = currentUrl
            }

          },
          error: function(errorData){
            console.log("Error");
            console.log(errorData);
          }
        })
      }
    })
  </script>


</body>
</html>
